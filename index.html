<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ranglista</title>

  <style>
    :root{
      --bg:#050507;
      --panel:#0b0e14;
      --glass:rgba(255,255,255,0.06);
      --line:rgba(255,255,255,0.08);
      --gold:#e3c770;
      --text:#f2f2f2;
      --muted:#a7a7b0;
    }
    body{margin:0;background:#050507;color:var(--text);font-family:Inter,Arial,sans-serif;}
    .wrap{padding:26px;display:flex;justify-content:center;}
    .board{width:100%;max-width:1200px;background:var(--panel);border-radius:20px;padding:22px;border:1px solid var(--line);}    
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;}
    .logo{font-size:26px;font-weight:800;color:var(--gold);}    
    .main{display:flex;gap:24px;}
    .left{flex:1;}
    .right{width:320px;}
    .card{background:var(--glass);padding:16px;border-radius:18px;border:1px solid var(--line);}

    .table{border-radius:14px;overflow:hidden;margin-top:8px;}
    .row{display:grid;grid-template-columns:55px 1fr 120px;padding:10px 14px;border-bottom:1px solid var(--line);}
    .row.header{color:var(--muted);text-transform:uppercase;font-size:13px;}
    .rank{font-weight:700;color:var(--gold);}    
    .chips{text-align:right;color:var(--gold);font-weight:700;}

    .pager{display:flex;justify-content:center;gap:10px;margin-top:12px;}
    .pagebtn{background:transparent;border:1px solid var(--line);color:var(--text);padding:6px 12px;border-radius:8px;cursor:pointer;}
    .pagebtn.active{border-color:var(--gold);color:var(--gold);}    

    .time{font-size:44px;text-align:center;color:var(--gold);font-weight:800;}
    .state{text-align:center;color:var(--muted);margin-top:4px;}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.75);display:none;align-items:center;justify-content:center;z-index:200;}    
    .modal{background:var(--panel);padding:22px;border-radius:16px;width:100%;max-width:420px;border:1px solid var(--line);}    
    .form-row{display:flex;flex-direction:column;margin-bottom:14px;}    
    input{padding:10px;border-radius:10px;border:1px solid var(--line);background:#0002;color:var(--text);}    
    .row-actions{display:flex;justify-content:flex-end;gap:12px;}    
    .btn{padding:10px 18px;border-radius:10px;border:1px solid var(--line);background:#111;color:var(--text);cursor:pointer;}    
    .btn:hover{border-color:var(--gold);color:var(--gold);}    
  </style>
</head>
<body>
<div class="wrap">
  <div class="board">

    <header><div class="logo">Ranglista</div></header>

    <div class="main">
      <div class="left">
        <div class="card">
          <div class="table" id="leaderboard"><div class="row header"><div>#</div><div>Név</div><div>Pont</div></div></div>
          <div class="pager" id="pager"></div>
        </div>
      </div>
      <div class="right">
        <div class="card">
          <div class="time" id="time-display">—</div>
          <div class="state" id="countdown-state">Inaktív</div>
        </div>
      </div>
    </div>

  </div>
</div>

<div class="modal-backdrop" id="modal"><div class="modal" id="modal-content"></div></div>

<script type="module">

const firebaseConfig = {
  apiKey: "AIzaSyAD3LRjJ_2DjK243U30BWSp_t8LWezZUVs",
  authDomain: "pontszamlalo.firebaseapp.com",
  projectId: "pontszamlalo",
  storageBucket: "pontszamlalo.firebasestorage.app",
  messagingSenderId: "323030067350",
  appId: "1:323030067350:web:6dd018fbf3f5c10703fab7",
  measurementId: "G-5LM0TMLW2W",
  databaseURL: "https://pontszamlalo-default-rtdb.europe-west1.firebasedatabase.app"
};

await import("https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js");
await import("https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js");

firebase.initializeApp(firebaseConfig);
const db = firebase.database().ref("leaderboard-state");

let state = { players:{}, countdown:null };
let currentPage = 0;
const PAGE_SIZE = 10;
const $ = s => document.querySelector(s);
const modal = $("#modal");
const modalContent = $("#modal-content");

const openModal = html => { modalContent.innerHTML = html; modal.style.display="flex"; };
const closeModal = ()=>{ modal.style.display="none"; modalContent.innerHTML=""; };
modal.addEventListener("click",e=>{ if(e.target===modal) closeModal(); });

function pushState(){ db.set(state); }

db.on("value",snap=>{
  state = snap.val() || {players:{},countdown:null};
  renderAll();
});

function sorted(){
  return Object.entries(state.players).map(([id,p])=>({id,...p})).sort((a,b)=>b.chips-a.chips);
}

function renderLeaderboard(){
  const c=$("#leaderboard"); c.querySelectorAll(".player").forEach(e=>e.remove());
  const arr=sorted();
  const pages=Math.max(1,Math.ceil(arr.length/PAGE_SIZE));
  if(currentPage>=pages) currentPage=pages-1;
  const slice=arr.slice(currentPage*PAGE_SIZE,(currentPage+1)*PAGE_SIZE);

  slice.forEach((p,i)=>{
    const r=document.createElement("div");
    r.className="row player";
    r.innerHTML=`<div class="rank">${currentPage*PAGE_SIZE+i+1}</div><div>${p.name}</div><div class="chips">${p.chips}</div>`;
    c.appendChild(r);
  });
  renderPager(pages);
}

function renderPager(pages){
  const p=$("#pager"); p.innerHTML="";
  for(let i=0;i<pages;i++){
    const b=document.createElement("button");
    b.className="pagebtn"+(i===currentPage?" active":"");
    b.textContent=i+1;
    b.onclick=()=>{currentPage=i;renderAll();};
    p.appendChild(b);
  }
}

function renderCountdown(){
  const t=$("#time-display"), s=$("#countdown-state");
  if(!state.countdown){ t.textContent="—"; s.textContent="Inaktív"; return; }
  const rem=Math.max(0,Math.floor((state.countdown-Date.now())/1000));
  const h=String(Math.floor(rem/3600)).padStart(2,"0");
  const m=String(Math.floor((rem%3600)/60)).padStart(2,"0");
  const sc=String(rem%60).padStart(2,"0");
  t.textContent=`${h}:${m}:${sc}`;
  s.textContent = rem>0?"Aktív":"Lejárt";
}

function renderAll(){ renderLeaderboard(); renderCountdown(); }
setInterval(renderCountdown,500);

function ensurePlayer(name){
  const e=Object.entries(state.players).find(x=>x[1].name.toLowerCase()===name.toLowerCase());
  if(e) return e[0];
  const id="p_"+Math.random().toString(36).slice(2,9);
  state.players[id]={name, chips:0}; pushState(); return id;
}
function addPoints(name,delta){ const id=ensurePlayer(name); state.players[id].chips+=delta; pushState(); }
function deletePlayer(id){ delete state.players[id]; pushState(); }

function modalAddPlayer(){
  openModal(`<h3>Név hozzáadása</h3>
  <div class='form-row'><input id='m_name'></div>
  <div class='row-actions'><button class='btn' onclick='closeModal()'>Mégse</button><button class='btn' onclick='modalAddPlayerOK()'>OK</button></div>`);
}
window.modalAddPlayerOK=()=>{ const n=document.getElementById("m_name").value.trim(); if(!n)return; ensurePlayer(n); closeModal(); };

function modalEditPoints(){
  openModal(`<h3>Pont módosítása</h3>
  <div class='form-row'><label>Név</label><input id='m_name'></div>
  <div class='form-row'><label>Változás</label><input id='m_delta' type='number'></div>
  <div class='row-actions'><button class='btn' onclick='closeModal()'>Mégse</button><button class='btn' onclick='modalEditPointsOK()'>OK</button></div>`);
}
window.modalEditPointsOK=()=>{ const n=m_name.value.trim(); const d=Number(m_delta.value); if(!n||isNaN(d))return; addPoints(n,d); closeModal(); };

function modalSetTimer(){
  openModal(`<h3>Visszaszámláló</h3>
  <div class='form-row'><label>Perc</label><input id='m_min' type='number'></div>
  <div class='row-actions'><button class='btn' onclick='closeModal()'>Mégse</button><button class='btn' onclick='modalSetTimerOK()'>OK</button></div>`);
}
window.modalSetTimerOK=()=>{ const m=Number(m_min.value); if(!m)return; state.countdown=Date.now()+m*60000; pushState(); closeModal(); };

function modalDelete(){
  let list = sorted().map(p=>`<div><label><input type='radio' name='del' value='${p.id}'> ${p.name}</label></div>`).join("");
  openModal(`<h3>Játékos törlése</h3>${list}<div class='row-actions'><button class='btn' onclick='closeModal()'>Mégse</button><button class='btn' onclick='modalDeleteOK()'>Törlés</button></div>`);
}
window.modalDeleteOK=()=>{
  const id=[...document.querySelectorAll("input[name='del']")].find(r=>r.checked)?.value;
  if(id){ deletePlayer(id); }
  closeModal();
};

document.addEventListener("keydown",e=>{
  if(modal.style.display==="flex") return;
  const k=e.key.toLowerCase();
  if(k==="p") modalAddPlayer();
  if(k==="e") modalEditPoints();
  if(k==="i") modalSetTimer();
  if(k==="l") modalDelete();
  if(k==="x"){ currentPage=Math.max(0,currentPage-1); renderAll(); }
  if(k==="y"){ currentPage=currentPage+1; renderAll(); }
});

renderAll();

</script>
</body>
</html>
